/*
    inout.cpp


    flexemu, an MC6809 emulator running FLEX
    Copyright (C) 1997-2018  W. Schwotzer

    This program is free software; you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation; either version 2 of the License, or
    any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program; if not, write to the Free Software
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
*/


#include "misc1.h"

#include "inout.h"
#include "e2floppy.h"
#include "mc6821.h"
#include "mc146818.h"
#include "absgui.h"
#include "joystick.h"
#include "terminal.h"

#ifdef HAVE_XTK
    #include "xtgui.h"
#endif

#ifdef _WIN32
    #include "win32gui.h"
#endif


Inout::Inout(
        E2floppy &x_fdc,
        Mc146818 &x_rtc)
     : fdc(x_fdc)
     , rtc(x_rtc)
     , gui(nullptr)
     , local_serpar_address(-1)
{
}

Inout::~Inout()
{
}

void Inout::get_drive_status(DiskStatus status[4])
{
    fdc.get_drive_status(status);
}

std::string Inout::get_drive_info(int floppyIndex)
{
    return fdc.drive_info(floppyIndex);
}

void Inout::create_gui(JoystickIO &joystickIO,
                       KeyboardIO &keyboardIO, TerminalIO &terminalIO,
                       Pia1 &pia1,
                       Memory &memory, Scheduler &scheduler,
                       Mc6809 &cpu,
                       VideoControl1 &vico1, VideoControl2 &vico2,
                       struct sGuiOptions &options)
{
#ifdef UNIT_TEST
    (void)joystickIO;
    (void)keyboardIO;
    (void)terminalIO;
    (void)pia1;
    (void)memory;
    (void)scheduler;
    (void)cpu;
    (void)vico1;
    (void)vico2;
    (void)options;
#else
    // Only allow to open Gui once.
    if (gui == nullptr)
    {
        switch (static_cast<GuiType>(options.guiType))
        {
#ifdef HAVE_XTK

            case GuiType::XTOOLKIT:
                gui = std::unique_ptr<AbstractGui>(
                       new XtGui(cpu, memory, scheduler, *this, vico1, vico2,
                                joystickIO, keyboardIO, terminalIO,
                                pia1, options));
                break;
#endif
#ifdef _WIN32

            case GuiType::WINDOWS:
                gui = std::unique_ptr<AbstractGui>(
                       new Win32Gui(cpu, memory, scheduler, *this, vico1, vico2,
                                   joystickIO, keyboardIO, terminalIO,
                                   pia1, options));
                break;
#endif
            default:
                throw FlexException(FERR_UNSUPPORTED_GUI_TYPE,
                        static_cast<int>(options.guiType));
                break;
        }
    }
#endif // UNIT_TEST
}

// one second updates are generated by the cpu
// in this method they will be transmitted to all objects
// which need it
void Inout::update_1_second()
{
    rtc.update_1_second();
}

bool Inout::is_gui_present()
{
    return gui != nullptr;
}

Word Inout::output_to_terminal()
{
#ifdef HAVE_TERMIOS_H

    if (is_gui_present())
    {
        gui->output_to_terminal();
    }

    return 1;
#else
    return 0;
#endif // #ifdef HAVE_TERMIOS_H
}

Word Inout::output_to_graphic()
{
    if (is_gui_present())
    {
        gui->output_to_graphic();
        return 1;
    }

    return 0;
}

void Inout::main_loop()
{
    if (is_gui_present())
    {
        gui->main_loop();
    }
}

int Inout::serpar_address() const
{
    return local_serpar_address;
}

void Inout::serpar_address(int value)
{
    local_serpar_address = value;
}
